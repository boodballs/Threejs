<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Three.js Scene</title>
    <style>
        /* Basic styling for body and canvas */
        body {
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
            font-family: 'Inter', sans-serif; /* Use Inter font */
            background-color: #111; /* Dark background */
            color: #fff; /* Default text color */
        }
        canvas {
            display: block; /* Remove extra space below canvas */
            width: 100%;   /* Make canvas fill width */
            height: 100vh; /* Make canvas fill viewport height */
        }
        /* Styling for informational text overlay */
        #info {
            position: absolute;
            top: 10px;
            left: 10px; /* Position left */
            right: 10px; /* Position right */
            text-align: center;
            color: #fff;
            padding: 8px 12px; /* More padding */
            background-color: rgba(0, 0, 0, 0.7); /* Slightly darker background */
            z-index: 1000;
            font-size: 0.9em;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* Add subtle shadow */
            max-width: calc(100% - 20px); /* Prevent overflow */
            box-sizing: border-box; /* Include padding in width calculation */
            pointer-events: none; /* Allow clicks to pass through info overlay */
        }
        /* Styling for loading overlay */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            display: flex; /* Use flexbox for centering */
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Ensure it's above info initially */
            font-size: 1.2em;
            text-align: center;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <script>
        // Global flag to track script loading errors
        let scriptLoadErrorOccurred = false;
        // Function to handle script loading errors
        function scriptLoadError(scriptName) {
            console.error(`Error loading script: ${scriptName}`);
            const infoElement = document.getElementById('info');
            if (infoElement && !scriptLoadErrorOccurred) { // Show only the first error
                infoElement.textContent = `Error: Failed to load required script (${scriptName}). Check network connection, browser console (Network tab), and extensions.`;
            }
            const loadingElement = document.getElementById('loading');
            if (loadingElement) loadingElement.style.display = 'none'; // Hide loading overlay
            scriptLoadErrorOccurred = true; // Set flag to prevent further messages
        }
    </script>

    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.161.0/three.min.js"
        integrity="sha512-Pk3ICL+Mn9UPFjBCbzAm+QcG3hnAwoqGvJ4KWp7kbVODdR68dwL3LgqHWHdWbXJ+6B9N36E62Dk03e9CHJ/5xg=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        defer
        onerror="scriptLoadError('three.min.js')">
    </script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.161.0/examples/js/loaders/GLTFLoader.min.js"
        integrity="sha512-mB7wN9e53FmSFkbM8PO981A5N/Y6A+7wI4j0j7jdrg2fN7gAgQjpx6Vn/uQqsFR5j/4159pLhR+u+69U+Lqgfw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        defer
        onerror="scriptLoadError('GLTFLoader.js')">
    </script>
     <script
        src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.161.0/examples/js/controls/OrbitControls.min.js"
        integrity="sha512-YNQkIY5/80uY9/bM8zWj/Lg9zP90V7bJp+uGqX+Pz9/n0a+a6lB4aA+hH/3/w8/v/Qn/bNq/EpF0KA=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        defer
        onerror="scriptLoadError('OrbitControls.js')">
     </script>

</head>
<body>
    <div id="info">Loading...</div>
    <div id="loading"><p>Initializing Scene...</p></div>

    <script>
        // Wait for the DOM to be fully loaded and parsed
        document.addEventListener('DOMContentLoaded', (event) => {

            // If a script loading error already occurred, don't proceed
            if (scriptLoadErrorOccurred) {
                console.log("Initialization skipped due to script load error.");
                return;
            }

            // Declare variables in a scope accessible within this event listener
            let scene, camera, renderer, controls, raycaster, pointer, selectedObject = null;
            const interactiveObjects = []; // Keep track of objects that can be interacted with

            /**
             * Initializes the entire Three.js scene, camera, renderer, lights, objects, and event listeners.
             */
            function init() {
                // Check if THREE is defined *before* trying to use it
                // This check is now secondary; the onerror handler is the primary check for loading failure.
                if (typeof THREE === 'undefined') {
                    // This case might occur if the script loaded but failed to execute/define THREE correctly,
                    // or if the onerror handler somehow failed.
                    console.error("FATAL: THREE object not defined even after DOMContentLoaded and no script load error detected. Investigate script execution.");
                    const infoElement = document.getElementById('info');
                    const loadingElement = document.getElementById('loading');
                    if (infoElement) infoElement.textContent = "Error: Three.js loaded but failed to initialize. Check browser console for execution errors.";
                    if (loadingElement) loadingElement.style.display = 'none';
                    return; // Stop initialization
                }

                // --- Proceed with initialization now that THREE is confirmed ---
                try {
                    // Optional: Check if addons loaded correctly *after* confirming THREE exists
                    // Use the minified versions from cdnjs examples if available, otherwise check standard path
                     if (!THREE.GLTFLoader) {
                        console.warn("THREE.GLTFLoader not found. Ensure GLTFLoader.js loaded correctly.");
                    }
                    if (!THREE.OrbitControls) {
                        console.warn("THREE.OrbitControls not found. Ensure OrbitControls.js loaded correctly.");
                    }


                    // --- Basic Scene Setup ---
                    scene = new THREE.Scene();
                    scene.background = new THREE.Color(0x1a1a1a);

                    // --- Camera Setup ---
                    const aspect = window.innerWidth / window.innerHeight;
                    camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
                    camera.position.set(0, 1.5, 5);

                    // --- Renderer Setup ---
                    renderer = new THREE.WebGLRenderer({
                        antialias: true,
                        alpha: true
                     });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.setPixelRatio(window.devicePixelRatio);
                    document.body.appendChild(renderer.domElement);

                    // --- Loading Manager ---
                    const loadingManager = new THREE.LoadingManager(
                        () => { // onLoad
                            console.log("Loading complete!");
                            document.getElementById('info').textContent = 'Scene Ready. Click/Tap objects.';
                            const loadingElement = document.getElementById('loading');
                            if (loadingElement) loadingElement.style.display = 'none';
                        },
                        (url, itemsLoaded, itemsTotal) => { // onProgress
                            const percent = Math.round((itemsLoaded / itemsTotal) * 100);
                            document.getElementById('info').textContent = `Loading assets: ${percent}%`;
                            console.log(`Loading file: ${url} (${itemsLoaded}/${itemsTotal})`);
                        },
                        (url) => { // onError
                            console.error(`Error loading file via LoadingManager: ${url}`);
                            document.getElementById('info').textContent = `Error loading asset: ${url}`;
                        }
                    );

                    // --- Lighting Setup ---
                    const ambientLight = new THREE.AmbientLight(0x606060);
                    scene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(5, 10, 7.5);
                    scene.add(directionalLight);
                    const pointLight = new THREE.PointLight(0xff4400, 0.7, 50);
                    pointLight.position.set(-3, 3, 3);
                    scene.add(pointLight);

                    // --- Geometry and Materials ---
                    const boxGeometry = new THREE.BoxGeometry(1, 1, 1);
                    const sphereGeometry = new THREE.SphereGeometry(0.7, 32, 32);
                    const torusKnotGeometry = new THREE.TorusKnotGeometry(0.8, 0.3, 100, 16);
                    const boxMaterial = new THREE.MeshStandardMaterial({ color: 0x3399ff, roughness: 0.4, metalness: 0.2 });
                    const sphereMaterial = new THREE.MeshStandardMaterial({ color: 0xff6600, roughness: 0.7, metalness: 0.1 });
                    const torusKnotMaterial = new THREE.MeshStandardMaterial({ color: 0x99cc33, roughness: 0.2, metalness: 0.8 });

                    // --- Creating Meshes (Objects) ---
                    const box = new THREE.Mesh(boxGeometry, boxMaterial);
                    box.position.set(-2.5, 0.5, 0);
                    box.userData.originalColor = boxMaterial.color.getHex();
                    box.userData.name = "Cube";
                    scene.add(box);
                    interactiveObjects.push(box);

                    const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
                    sphere.position.set(2.5, 0.7, 0);
                    sphere.userData.originalColor = sphereMaterial.color.getHex();
                    sphere.userData.name = "Sphere";
                    scene.add(sphere);
                    interactiveObjects.push(sphere);

                    const torusKnot = new THREE.Mesh(torusKnotGeometry, torusKnotMaterial);
                    torusKnot.position.set(0, 1.0, -1.5);
                    torusKnot.userData.originalColor = torusKnotMaterial.color.getHex();
                    torusKnot.userData.name = "Torus Knot";
                    scene.add(torusKnot);
                    interactiveObjects.push(torusKnot);

                    // --- Raycaster for Interaction ---
                    raycaster = new THREE.Raycaster();
                    pointer = new THREE.Vector2();

                    // --- Orbit Controls ---
                    if (THREE.OrbitControls) {
                        controls = new THREE.OrbitControls(camera, renderer.domElement);
                        controls.enableDamping = true;
                        controls.dampingFactor = 0.05;
                        controls.screenSpacePanning = false;
                        controls.minDistance = 2;
                        controls.maxDistance = 20;
                        controls.maxPolarAngle = Math.PI / 1.8;
                        controls.target.set(0, 0.5, 0);
                        controls.update();
                    } else {
                         document.getElementById('info').textContent = "Warning: Camera controls unavailable.";
                    }


                    // --- Event Listeners ---
                    window.addEventListener('pointerdown', onPointerDown);
                    window.addEventListener('pointerup', onPointerUp);
                    window.addEventListener('pointermove', onPointerMove);
                    window.addEventListener('resize', onWindowResize);

                    // Hide loading overlay now that basic setup is done
                    const loadingElement = document.getElementById('loading');
                    if (loadingElement) loadingElement.style.display = 'none';
                    document.getElementById('info').textContent = 'Initializing...';

                    // --- Start Animation Loop ---
                    animate();

                    // Final confirmation message if no assets were managed by LoadingManager
                    if (loadingManager.isLoading === false) {
                         document.getElementById('info').textContent = 'Scene Ready. Click/Tap objects.';
                    }

                } catch (error) {
                    // --- Error Handling during Initialization ---
                    console.error("Error during Three.js initialization:", error);
                    const infoElement = document.getElementById('info');
                    const loadingElement = document.getElementById('loading');
                    if (loadingElement) loadingElement.style.display = 'none';

                    if (error instanceof WebGLRenderingContext || error.message.toLowerCase().includes('webgl')) {
                         infoElement.textContent = "Error: WebGL is not available or failed to initialize. Please use a compatible browser/device.";
                    } else if (error.message.includes("THREE")) {
                         infoElement.textContent = `Error: A component of Three.js failed (${error.message}). Check console.`;
                    } else {
                        infoElement.textContent = "An unexpected error occurred initializing the 3D scene. Check console.";
                    }

                    if (renderer && renderer.domElement && renderer.domElement.parentNode) {
                        renderer.domElement.parentNode.removeChild(renderer.domElement);
                    }
                    return; // Exit init function
                }
            }

            // ... (rest of the functions: onPointerDown, onPointerUp, onPointerMove, selectObject, deselectObject, onWindowResize, animate) ...
            // These functions remain the same as the previous version

            /**
             * Handles pointer (mouse click or touch tap) down events for object interaction.
             */
            function onPointerDown(event) {
                if (!camera || !raycaster || !pointer) return; // Ensure prerequisites exist
                pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObjects(interactiveObjects);

                if (intersects.length > 0) {
                    if (selectedObject && selectedObject !== intersects[0].object) {
                        deselectObject();
                    }
                    selectedObject = intersects[0].object;
                    selectObject(selectedObject);
                } else {
                    if (selectedObject) {
                        deselectObject();
                    }
                }
            }

            /**
             * Handles pointer up events.
             */
            function onPointerUp(event) {
                // Placeholder for future use (e.g., ending drag)
            }

            /**
             * Handles pointer move events.
             */
            function onPointerMove(event) {
                if (!pointer) return;
                 pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                 pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;
                 // Placeholder for future use (e.g., hover effects)
            }

            /**
             * Applies visual changes to indicate an object is selected.
             * @param {THREE.Object3D} object The object to select.
             */
            function selectObject(object) {
                if (!object || !object.material) return;
                // Ensure originalColor was stored
                if (object.userData.originalColor === undefined) {
                     object.userData.originalColor = object.material.color.getHex();
                }
                object.material.color.set(0xffffff); // Highlight color
                object.scale.set(1.15, 1.15, 1.15);
                document.getElementById('info').textContent = `Selected: ${object.userData.name || 'Object'}`;
            }

            /**
             * Reverts visual changes when an object is deselected.
             */
            function deselectObject() {
                if (!selectedObject || !selectedObject.material) return;
                // Restore original color only if it was stored
                if (selectedObject.userData.originalColor !== undefined) {
                     selectedObject.material.color.setHex(selectedObject.userData.originalColor);
                } else {
                    console.warn("Original color not found for deselected object:", selectedObject);
                }
                selectedObject.scale.set(1, 1, 1);
                selectedObject = null;
                document.getElementById('info').textContent = 'Scene Ready. Click/Tap objects.';
            }


            /**
             * Handles window resize events to keep the scene responsive.
             */
            function onWindowResize() {
                if (!camera || !renderer) return;
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
            }

            /**
             * The main animation loop.
             */
            function animate() {
                // Request the next frame. If init failed, this won't be called initially.
                // Also stop if a script load error occurred earlier
                 if (scriptLoadErrorOccurred) return;

                requestAnimationFrame(animate);

                // Update controls if they exist
                if (controls) controls.update();

                // --- Animations ---
                interactiveObjects.forEach((obj, index) => {
                    if (obj !== selectedObject) { // Don't rotate the selected object
                        obj.rotation.y += 0.005 + index * 0.001;
                        obj.rotation.x += 0.002 + index * 0.0005;
                    }
                });

                // Render the scene if renderer and scene exist
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            }


            // --- Start Initialization ---
            // Call init() now that the DOM is ready. It includes checks for THREE definition and script load errors.
            init();

        }); // End of DOMContentLoaded listener
    </script>
</body>
</html>
